import { NextResponse } from "next/server";
import { connectDB } from "@/lib/db";
import Order from "@/models/Order";
import OrderHistory from "@/models/OrderHistory";
import { Resend } from "resend";

const resend = new Resend(process.env.RESEND_API_KEY);

export async function DELETE(req, { params }) {
  try {
    await connectDB();
    const { id } = params;
    const { action } = await req.json(); // "accept" or "decline"

    const order = await Order.findById(id);
    if (!order) {
      return NextResponse.json({ error: "Order not found" }, { status: 404 });
    }

    // üßÆ Calculate total
    const total = order.cart.reduce(
      (sum, item) =>
        sum + item.sizes.reduce((s, sz) => s + sz.quantity * item.price, 0),
      0
    );

    // üìù Simplify product list for history DB
    const simplifiedProducts = order.cart.flatMap((item) =>
      item.sizes.map((sz) => ({
        name: item.name,
        size: sz.size,
        quantity: sz.quantity,
      }))
    );

    // üíå Email setup
    const itemList = order.cart
      .map((item) => {
        const sizeInfo = item.sizes
          .map((s) => `${s.size} (${s.quantity})`)
          .join(", ");
        return `<li><strong>${item.name}</strong>: ${sizeInfo}</li>`;
      })
      .join("");

    let subject = "";
    let html = "";

    if (action === "accept") {
      subject = "–í–∞—à–∞—Ç–∞ –Ω–∞—Ä–∞—á–∫–∞ –µ –ø–æ—Ç–≤—Ä–¥–µ–Ω–∞ ‚úÖ";
      html = `
        <p>–ü–æ—á–∏—Ç—É–≤–∞–Ω(–∞) ${order.name},</p>
        <p>–í–∞—à–∞—Ç–∞ –Ω–∞—Ä–∞—á–∫–∞ –µ –ø—Ä–∏—Ñ–∞—Ç–µ–Ω–∞ –∏ —ú–µ –±–∏–¥–µ –∏—Å–ø–æ—Ä–∞—á–∞–Ω–∞ –Ω–∞—Å–∫–æ—Ä–æ.</p>
        <p><strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏:</strong></p>
        <ul>${itemList}</ul>
        <p><strong>–í–∫—É–ø–Ω–∞ —Å—É–º–∞:</strong> ${total} –¥–µ–Ω</p>
        <p>–í–∏ –±–ª–∞–≥–æ–¥–∞—Ä–∏–º–µ!</p>
      `;
    } else if (action === "decline") {
      subject = "–í–∞—à–∞—Ç–∞ –Ω–∞—Ä–∞—á–∫–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –±–∏–¥–µ –∏—Å–ø–æ–ª–Ω–µ—Ç–∞ ‚ùå";
      html = `
        <p>–ü–æ—á–∏—Ç—É–≤–∞–Ω(–∞) ${order.name},</p>
        <p>–ó–∞ –∂–∞–ª, –Ω–µ –º–æ–∂–µ–º–µ –¥–∞ —ò–∞ –∏—Å–ø–æ—Ä–∞—á–∞–º–µ –≤–∞—à–∞—Ç–∞ –Ω–∞—Ä–∞—á–∫–∞ –≤–æ –º–æ–º–µ–Ω—Ç–æ–≤.</p>
        <p>–í–µ –º–æ–ª–∏–º–µ –æ–±–∏–¥–µ—Ç–µ —Å–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–¥–æ—Ü–Ω–∞.</p>
      `;
    }

    // üì¨ Send email
    await resend.emails.send({
      from: process.env.EMAIL_FROM,
      to: order.email,
      subject,
      html,
    });

    // üóÉ Move to OrderHistory
    await OrderHistory.create({
      name: order.name,
      email: order.email,
      address: order.address,
      phone: order.phone,
      products: simplifiedProducts,
      total,
      status: action === "accept" ? "accepted" : "declined",
    });

    // üßπ Delete from active orders
    await order.deleteOne();

    return NextResponse.json({ message: "Moved to history." });
  } catch (err) {
    console.error("Error processing order:", err);
    return NextResponse.json({ error: "Internal error" }, { status: 500 });
  }
}
